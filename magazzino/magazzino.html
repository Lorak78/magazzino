<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="grafica.css">
    <title>Document</title>
</head>

<body>
    <input type="text" id="text">
    <input type="submit" id="cerca" value="Cerca">
    <button id="subTotale">subTotale</button>

    <div id="dinamico"></div>

    <script>
        let url = "./magazzinoJson.json";

        let codice = document.getElementById("text");
        let cerca = document.getElementById("cerca");
        let subTotale = document.getElementById("subTotale");
        let div_messaggi = document.getElementById("dinamico");

        let datiJson

        fetch(url)
            .then(response => response.json()) //richiamo la funzione json
            .then(dati => {
                datiJson = dati
            })

        cerca.addEventListener("click", function (e) {
            e.defaultPrevented;

            div_messaggi.innerHTML = ""
            modifica = []
            rimuovi = []
            if (codice.value != "") {
                div_messaggi.innerHTML =
                    `<table id="dati">
                        <tr>
                            <th>Codice</th>
                            <th>Reparto</th>
                            <th>Tipo Prodotto</th>
                            <th>Marca</th>
                            <th>Modello Nome</th>
                            <th>Quantit√†</th>
                            <th>Prezzo</th>
                            <th>Nominativo Responsabile</th>
                            <th>Cellulare Responsabile</th>
                            <th>Fornitore1</th>
                            <th>Costo1</th>
                            <th>Fornitore2</th>
                            <th>Costo2</th>
                            <th>IVA</th>
                            <th>Azioni</th>
                        </tr>
                    </table>`
            }

            datiJson.forEach(element => {
                if (codice.value == element.codiceProd) {
                    createRowTable(element)

                } else if (codice.value == element.reparto) {
                    //console.log(element)
                    createRowTable(element)

                } else if (codice.value == element.tipoProdotto) {
                    //console.log(element)
                    createRowTable(element)

                } else if (codice.value == element.modelloNome) {
                    //console.log(element)
                    createRowTable(element)

                } else if (codice.value == element.marca) {
                    //console.log(element)
                    createRowTable(element)

                }
            });
        })

        subTotale.addEventListener("click", () => {
            let lista_subTotali = []

            div_messaggi.innerHTML = ""

            datiJson.forEach(element => {
                let esiste = lista_subTotali.some(function (obj) {
                    return obj.reparto === element.reparto
                })

                if (esiste) {
                    lista_subTotali.forEach(el_reparto => {
                        if (el_reparto.reparto == element.reparto) {
                            el_reparto.pz_tot += element.qt
                            el_reparto.val_tot += element.qt * element.prezzo
                        }
                    })
                } else {
                    let oggetto = { reparto: element.reparto, pz_tot: element.qt, val_tot: (element.qt * element.prezzo) }
                    lista_subTotali.push(oggetto)
                }

            })

            lista_subTotali.forEach(el_reparto => {
                div_messaggi.innerHTML += `<b>Reparto:</b> ${el_reparto.reparto} <b>Totale Pezzi:</b> ${el_reparto.pz_tot} <b>Valora Totale:</b> ${el_reparto.val_tot}<br><br>`
            })

            console.log(lista_subTotali)
        });

        function createRowTable(element) {
            let ricerca = codice.value
            let tabella = document.getElementById("dati");
            let riga = tabella.insertRow();

            // Inserisci le celle nella riga
            riga.insertCell(0).innerHTML = element.codiceProd;
            riga.insertCell(1).innerHTML = element.reparto;
            riga.insertCell(2).innerHTML = element.tipoProdotto;
            riga.insertCell(3).innerHTML = element.marca;
            riga.insertCell(4).innerHTML = element.modelloNome;
            riga.insertCell(5).innerHTML = element.qt;
            riga.insertCell(6).innerHTML = element.prezzo;
            riga.insertCell(7).innerHTML = element.nominativoResponsabile;
            riga.insertCell(8).innerHTML = element.cellResp;
            riga.insertCell(9).innerHTML = element.fornitore1;
            riga.insertCell(10).innerHTML = element.costo1;
            riga.insertCell(11).innerHTML = element.fornitore2;
            riga.insertCell(12).innerHTML = element.costo2;
            riga.insertCell(13).innerHTML = element.iva;

            let cellAzioni = riga.insertCell(14);

            const elimina = document.createElement('button');
            elimina.textContent = `elimina`;

            const modifica = document.createElement('button');
            modifica.textContent = `modifica`;

            cellAzioni.appendChild(modifica);
            cellAzioni.appendChild(elimina);

            modifica.addEventListener("click", () => {
                let conferma = confirm("Vuoi confermare la modifica dell'elemento?")
                alert("modifica: " + element.codiceProd);
            });

            elimina.addEventListener("click", () => {
                let conferma = confirm("Vuoi confermare la rimozione dell'elemento?")
                if (conferma) {
                    datiJson.splice(datiJson.findIndex(el => el.codiceProd === element.codiceProd), 1)
                    alert(element.codiceProd + ": eliminato");
                    codice.value = ricerca
                    cerca.click();
                }
            });
        }
    </script>
</body>

</html>